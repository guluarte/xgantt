<html>
<head>
    <title>How to Start with dhtmlxGantt</title>
    <script src="../Scripts/dhtmlxgantt.js"></script>
    <script src="../Script/SDK.REST.js"></script>
    <link href="../Styles/dhtmlxgant.css" rel="stylesheet" type="text/css">
</head>
<body>
    <div id="gantt_here" style="width: 1000px; height: 400px;"></div>
    <script type="text/javascript">

        if (window.parent.Xrm.Page.ui.getFormType() !== 1 || Window.parent.Xrm.Page.ui.getFormType() !== 5) {
            var tasks = {};
            tasks.data = [];
            tasks.links = [];
            SDK.REST.retrieveMultipleRecords(
                "Task",
                "$select=ActivityId, Subject,ActualStart,ActualDurationMinutes,ActualEnd,xrm_ParentGanttId,PercentComplete&$filter=xrm_ProjectId/Id eq guid'" + window.parent.Xrm.Page.data.entity.getId() + "'",
                function (results) {
                    tasks.data = [];
                    if (!results) return;
                    for (var i = 0; i < results.length; i++) {
                        tasks.data[i] = {
                            id: results[i].ActivityId,
                            text: results[i].Subject,
                            start_date: results[i].ActualStart,
                            end_date: results[i].ActualEnd,
                            duration: results[i].ActualDurationMinutes,
                            parent: results[i].xrm_ParentGanttId.Id,
                            progress: results[i].PercentComplete / 100
                        }
                    }
                    gantt.init("gantt_here");
                    gantt.parse(tasks);
                },
                function (error) { alert("fail retrieve all :" + error.message); },
                function () {
                }
            );

            var tasks1 = {
                data: [
                    {
                        id: 1,
                        text: "Project #1",
                        start_date: "01-04-2013",
                        duration: 11,
                        progress: 0.6,
                        open: true
                    },
                    {
                        id: 2,
                        text: "Task #1",
                        start_date: "03-04-2013",
                        duration: 5,
                        progress: 1,
                        open: true,
                        parent: 1
                    },
                    {
                        id: 3,
                        text: "Task #2",
                        start_date: "02-04-2013",
                        duration: 7,
                        progress: 0.5,
                        open: true,
                        parent: 1
                    },
                    {
                        id: 4,
                        text: "Task #2.1",
                        start_date: "03-04-2013",
                        duration: 2,
                        progress: 1,
                        open: true,
                        parent: 3
                    },
                    {
                        id: 5,
                        text: "Task #2.2",
                        start_date: "04-04-2013",
                        duration: 3,
                        progress: 0.8,
                        open: true,
                        parent: 3
                    },
                    {
                        id: 6,
                        text: "Task #2.3",
                        start_date: "05-04-2013",
                        duration: 4,
                        progress: 0.2,
                        open: true,
                        parent: 3
                    }
                ],
                links: [
                    { id: 1, source: 1, target: 2, type: "1" },
                    { id: 2, source: 1, target: 3, type: "1" },
                    { id: 3, source: 3, target: 4, type: "1" },
                    { id: 4, source: 4, target: 5, type: "0" },
                    { id: 5, source: 5, target: 6, type: "0" }
                ]

            };

            gantt.attachEvent("onAfterTaskAdd", function (id, item) {
                var task = gantt.getTask(id);
                var taskCrm = {
                    Subject: task.text,
                    ActualStart: new Date(task.start_date),
                    ActualDurationMinutes: task.duration,
                    ActualEnd: new Date(task.end_date),
                    xrm_ProjectId: {
                        Id: window.parent.Xrm.Page.data.entity.getId(),
                        LogicalName: window.parent.Xrm.Page.data.entity.getEntityName,
                        Name: window.parent.Xrm.Page.data.entity.getPrimaryAttributeValue
                    }
                };

                if (task.parent !== 0) {
                    var taskParent = gantt.getTask(task.parent);
                    taskCrm.xrm_ParentGanttId = {
                        Id: taskParent.id,
                        LogicalName: "task",
                        Name: taskParent.text
                    }
                }


                SDK.REST.createRecord(taskCrm,
                    "Task",
                    function (record) {
                        gantt.changeTaskId(task.id, record.ActivityId);
                    },
                    function (error) { alert("fail create :" + error.message); });
            });

            gantt.attachEvent("onBeforeTaskUpdate", function (id, item) {
                var task = gantt.getTask(id);
                var taskCrm = {
                    Subject: task.text,
                    ActualStart: new Date(task.start_date),
                    ActualDurationMinutes: task.duration,
                    ActualEnd: new Date(task.end_date),
                    PercentComplete: Math.round(task.progress * 100),
                    xrm_ProjectId: {
                        Id: window.parent.Xrm.Page.data.entity.getId(),
                        LogicalName: window.parent.Xrm.Page.data.entity.getEntityName,
                        Name: window.parent.Xrm.Page.data.entity.getPrimaryAttributeValue
                    }
                };

                if (task.parent !== 0) {
                    var taskParent = gantt.getTask(task.parent);
                    taskCrm.xrm_ParentGanttId = {
                        Id: taskParent.id,
                        LogicalName: "task",
                        Name: taskParent.text
                    }
                }

                SDK.REST.updateRecord(id,
                    taskCrm,
                    "Task",
                    function (record) {
                    },
                    function (error) { alert("fail update :" + error.message); });
            });

            gantt.attachEvent("onBeforeTaskDelete", function (id, item) {
                var toDelete = [];
                var j = 0;
                function recursivedelete() {
                    SDK.REST.deleteRecord(toDelete[j],
                        "Task",
                        function (record) {
                            j++;
                            if (j < toDelete.length)
                                recursivedelete();
                        },
                        function (error) { alert("fail update :" + error.message); });
                }

                toDelete[0] = id;
                for (var i = 0; i < toDelete.length; i++) {
                    if (!gantt.hasChild(toDelete[i])) continue;

                    toDelete.push.apply(toDelete, gantt.getChildren(toDelete[i]));
                }
                recursivedelete();
            });


            gantt.attachEvent("onBeforeLinkAdd", function (id, item) {
                var link = gantt.getlink(id);
                var taskCrm = {};
                taskCrm.Subject = link.text;
                taskCrm.ActualStart = new Date(link.start_date);
                taskCrm.ActualDurationMinutes = link.duration;
                taskCrm.ActualEnd = new Date(link.end_date);

                //taskCrm.xrm_ParentGanttId = task.parent;

                SDK.REST.createRecord(taskCrm,
                    "Task",
                    function (record) {
                        gantt.changeTaskId(task.id, record.ActivityId);
                    },
                    function (error) { alert("fail addlink :" + error.message); });
            });



        }
    </script>


</body>
</html>